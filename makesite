#!/bin/bash
# Written by M. De Graef; 10/11/18
# Project Funding: NSF DMR-1564550
#
# This script is Mac OS X specific... but might work on Linux with minor modifications
#
# This script is the top level script for building all the Magnetic Point Group web site files 
# It should be called simply as follows:
#
# ./makesite
#
# All options should be set in the WebSiteParameters file before running this script.
# To edit this file, first copy it from the WebSiteParameters.template file, and then edit the
# parameters for your site.

echo ""
date
echo ""
echo "Please note that the web files generated by this script will need to be accessed via a properly"
echo "installed web server.  The files use a number of scripts that will cause javascript security issues "
echo "when the index.html file is opened directly in a browser... the dropdown menus will almost certainly"
echo "not work correctly when opening the file from your local drive.  They only work when served via a "
echo "web server."
echo ""


# -------------------------------------------------------
# read the web site parameter(s)
WEB_FILE="WebSiteParameters"
if [ -f $WEB_FILE ]; then
    . $WEB_FILE
else
    echo "$WEB_FILE not found; exiting"
    exit
fi

# -------------------------------------------------------
# read the rendering parameters; needed to set the image/movie sizes
# in the various template files
RENDER_FILE="RenderParameters"
if [ -f $RENDER_FILE ]; then
    . $RENDER_FILE
else
    echo "$RENDER_FILE not found; exiting"
    exit
fi

CURDIR=`pwd`

# do we need to create the WEBSITE_FOLDER?
if [ -e "$WEBSITE_FOLDER" ] 
  then 
    echo "$WEBSITE_FOLDER already exists"
  else
    mkdir $WEBSITE_FOLDER
fi

# define the subfolders and then create them
HTML_FOLDER=$WEBSITE_FOLDER/html
STILLS_FOLDER=$WEBSITE_FOLDER/stills
MOVIES_FOLDER=$WEBSITE_FOLDER/movies
ARCHIVE_FOLDER=$WEBSITE_FOLDER/mpgarchive
mkdir $HTML_FOLDER
mkdir $STILLS_FOLDER
mkdir $MOVIES_FOLDER
mkdir $ARCHIVE_FOLDER

cd htmlgen

# place the main index.html file
echo "Generating $WEBSITE_FOLDER/index.html"
cp index.html "$WEBSITE_FOLDER"/index.html

# place the intro.html file
echo "Generating $HTML_FOLDER/intro.html"
cp intro.html "$HTML_FOLDER"/intro.html

# place the contacts.html file
echo "Generating $HTML_FOLDER/contacts.html"
cp contacts.html "$HTML_FOLDER"/contacts.html

# place the archives.html file
echo "Generating $HTML_FOLDER/archives.html"
cp archives.html "$HTML_FOLDER"/archives.html

# place the FAQ.html file
echo "Generating $HTML_FOLDER/FAQ.html"
cp FAQ.html "$HTML_FOLDER"/FAQ.html

# generate the navigation dropdown menus
echo "Generating navigation dropdown menus in $WEBSITE_FOLDER/menubar.html"
./mkall >"$WEBSITE_FOLDER"/menubar.html

echo "copying the point group label png files into the pglabels folder"
unzip pglabels.zip >/dev/null
mv pglabels $WEBSITE_FOLDER

# substitute the image/movie sizes in the html template files
echo "Initializing html point group template files with correct image and movie dimensions"
cd pages
cp still_template.original still_template
HEIGHTs=$(expr 32 + ${STILL_SIZE_MONTAGE}) 
sed -i back "s/WIDTH/${STILL_SIZE_MONTAGE}/g" still_template
sed -i back "s/HEIGHT/${STILL_SIZE_MONTAGE}/g" still_template
sed -i back "s/HEIGHTs/${HEIGHTs}/g" still_template
sed -i back "s/HIRESW/${STILL_SIZE}/g" still_template
rm still_templateback

cp movie_template.original movie_template
sed -i back "s/\$WIDTH\$/${MOVIE_SIZE}/g" movie_template
sed -i back "s/\$HEIGHT\$/${MOVIE_SIZE}/g" movie_template
rm movie_templateback

# generate the still and movie html files for all point groups and representation modes
echo "Generating all individual stills and movie pages in $HTML_FOLDER"
./mkallpages $HTML_FOLDER

cd $CURDIR

# then extract all the archive files into the correct folders
echo "Unpacking all individual stills $STILLS_FOLDER"
cd $STILLS_FOLDER
mkdir anaglyph axial polar scalar raw pseudoscalar 

echo "  --> anaglyphs"
cd anaglyph
cp $BUILD_FOLDER/anaglyph.tar.gz .
gunzip anaglyph.tar.gz
tar -xf anaglyph.tar 
rm *.tar

echo "  --> axial"
cd ../axial
cp $BUILD_FOLDER/axial_stills.tar.gz .
gunzip axial_stills.tar.gz
tar -xf axial_stills.tar 
rm *.tar

echo "  --> polar"
cd ../polar
cp $BUILD_FOLDER/polar_stills.tar.gz .
gunzip polar_stills.tar.gz
tar -xf polar_stills.tar 
rm *.tar

echo "  --> raw"
cd ../raw
cp $BUILD_FOLDER/raw_stills.tar.gz .
gunzip raw_stills.tar.gz
tar -xf raw_stills.tar 
rm *.tar

echo "  --> scalar"
cd ../scalar
cp $BUILD_FOLDER/scalar_stills.tar.gz .
gunzip scalar_stills.tar.gz
tar -xf scalar_stills.tar 
rm *.tar

echo "  --> pseudoscalar"
cd ../pseudoscalar
cp $BUILD_FOLDER/pseudoscalar_stills.tar.gz .
gunzip pseudoscalar_stills.tar.gz
tar -xf pseudoscalar_stills.tar 
rm *.tar


echo "Unpacking all individual movies $MOVIES_FOLDER"
cd $MOVIES_FOLDER
mkdir axial polar scalar pseudoscalar 

echo "  --> axial"
cd axial
cp $BUILD_FOLDER/axial_movies.tar.gz .
gunzip axial_movies.tar.gz
tar -xf axial_movies.tar
mv axial_movies/*.mp4 .
rmdir axial_movies
rm *.tar

echo "  --> polar"
cd ../polar
cp $BUILD_FOLDER/polar_movies.tar.gz .
gunzip polar_movies.tar.gz
tar -xf polar_movies.tar
mv polar_movies/*.mp4 .
rmdir polar_movies
rm *.tar

echo "  --> scalar"
cd ../scalar
cp $BUILD_FOLDER/scalar_movies.tar.gz .
gunzip scalar_movies.tar.gz
tar -xf scalar_movies.tar
rm *.tar

echo "  --> pseudoscalar"
cd ../pseudoscalar
cp $BUILD_FOLDER/pseudoscalar_movies.tar.gz .
gunzip pseudoscalar_movies.tar.gz
tar -xf pseudoscalar_movies.tar
rm *.tar

cd $CURDIR

echo "- - - - - - - - - - - - - - - - - - - - - - - - - "
echo "All is well that ends well ..."
date
exit
